#!/bin/sh
# Extract the initialization actions for builtin things.
#
#  Copyright (C) 1999, 2000 Free Software Foundation, Inc.
# 
# This program is free software; you can redistribute it and/or modify
# it under the terms of the GNU General Public License as published by
# the Free Software Foundation; either version 2, or (at your option)
# any later version.
# 
# This program is distributed in the hope that it will be useful,
# but WITHOUT ANY WARRANTY; without even the implied warranty of
# MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
# GNU General Public License for more details.
# 
# You should have received a copy of the GNU General Public License
# along with this software; see the file COPYING.  If not, write to
# the Free Software Foundation, Inc., 59 Temple Place, Suite 330,
# Boston, MA 02111-1307 USA

fullfilename=$1; shift

# strip path to source directory
filename=`basename $fullfilename`

# we need to be sure that the .x file exists
# since the .c/.cc file may include it
# (the old guile-snarf did not have this problem
#  because the makefile redirects output to the .x file
#  which creates the file before the inclusion occurs)
# --12/12/99 gjb
no_ext=`echo $filename | sed 's/\.[^.]*$//g'`
dot_doc=${no_ext}.doc

temp="/tmp/snarf.$$"
trap "rm -f $temp" 0 1 2 15

## Let the user override the preprocessor & awk autoconf found.
test -n "${CPP+set}" || CPP="@CPP@"
test -n "${AWK+set}" || AWK="@AWK@"

## Must run guile-func-name-check on the unpreprocessed source
${AWK} -f guile-func-name-check "$fullfilename"

## We must use a temporary file here, instead of a pipe, because we
## need to know if CPP exits with a non-zero status.
${CPP} -DSCM_MAGIC_SNARFER "$@" > ${temp} || exit $?
cut -c1-1023 ${temp} | ${AWK} -f `dirname $0`/guile-snarf.awk ${dot_doc}
